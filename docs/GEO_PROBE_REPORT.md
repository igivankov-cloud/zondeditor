# GEO Probe Report

Дата фиксации: 2026-03-01

## Команды запуска

```bash
python tools/geo_probe.py fixtures/K2_260205A1.GEO
python tools/geo_probe.py fixtures/К4_260218O1.GEO
```

Полные логи сохранены в:

- `logs/geo_probe_K2_260205A1.GEO.txt`
- `logs/geo_probe_К4_260218O1.GEO.txt`

## Результаты: `fixtures/K2_260205A1.GEO`

- Размер файла: **1627 bytes**.
- Найдено блоков: **6**.
- Сигнатуры блоков: `FF FF ?? 1E 0A` (вариант с дополнительным `FF FF` в первом блоке), плюс delimiter `FF FF` перед payload.
- `test_id`: читается как **1 byte** после `FF FF[ FF FF]` (смещение `id_off` в каждом блоке в логе).
- `rows`: считаются как `floor(data_len / 2)`.
- `bytes_per_row`: **2** (layout: `qc`, `fs`).
- `StepZond`: **не найдено** явным полем.
- Для первых 10 строк в каждом блоке удалось декодировать `qc` и `fs`; `depth` и `u` для K2 не определены (в логе помечены как `не найдено`).
- Проверка границ `data_off/data_len`: пересечений заголовка и выхода за пределы блока **не обнаружено**.

### Что пробовали для StepZond в K2

- Проверяли явное поле шага в заголовке около сигнатуры `FF FF ?? 1E 0A/14` — **не найдено**.
- Проверяли возможность стабильного смещения шага перед payload — **не найдено**.
- Гипотеза: шаг в данном варианте K2 либо не хранится в GEO-блоке явно, либо задаётся внешним контекстом/UI.

## Результаты: `fixtures/К4_260218O1.GEO`

- Размер файла: **30299 bytes**.
- Найдено блоков: **23**.
- Сигнатуры блоков: старт `FF FF`, внутри заголовка/префикса payload сигнатура `01 02 03 FF FF`.
- `test_id`: читается как **2 bytes little-endian** по смещению `+2` (`id_off`).
- `rows`: считаются как `floor(data_len / 9)` после `01 02 03 FF FF`.
- `bytes_per_row`: **9** (layout: `qc`, `fs`, `u` + служебные байты строки).
- `StepZond`: читается как **byte @ +5**, в метрах `step = value / 1000`.
- На этом fixture `StepZond` стабильно: **0.050 m** для всех найденных блоков.
- Для первых 10 строк в каждом блоке декодируются `depth`, `qc`, `fs`, `u`.
- Проверка границ `data_off/data_len`: пересечений заголовка и выхода за пределы блока **не обнаружено**.

## Выводы (K2 vs K4)

1. **Структура блока различается принципиально**:
   - K2: сигнатура `FF FF ?? 1E 0A/14`, данные парой байт (`qc/fs`), `bytes_per_row=2`.
   - K4: старт `FF FF`, якорь payload `01 02 03 FF FF`, `bytes_per_row=9`, есть колонка `u`.

2. **`test_id` стабильно извлекается в обоих форматах**, но:
   - K2: 1-байтовый id.
   - K4: 2-байтовый little-endian id.

3. **`rows` стабильно вычисляются через `data_len / bytes_per_row`** в обоих форматах.

4. **`StepZond` стабильно найден в K4**, но **не найден в K2**:
   - K4: `step_off=+5`, `step=value/1000`.
   - K2: явного поля шага в обследованных блоках не обнаружено.

5. Для дальнейшего "ремонта экспорта" сначала нужно опираться на это различие layout:
   - K2: короткая строка (2 байта), без явного `u` и без найденного `StepZond`.
   - K4: длинная строка (9 байт), с `u` и явным `StepZond`.
